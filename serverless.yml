service: heartland-contract-cadence-api
frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs22.x
  region: ap-northeast-1
  stage: ${opt:stage, 'dev'}
  timeout: 30
  memorySize: 512
  environment:
    NODE_ENV: ${opt:stage, 'dev'}
    FLOW_ACCESS_NODE: ${env:FLOW_ACCESS_NODE}
    HEART_CONTRACT_ADDRESS: ${env:HEART_CONTRACT_ADDRESS}
    JWT_SECRET: ${env:JWT_SECRET}
    # SQS resources
    TRANSACTION_QUEUE_URL:
      Ref: TransactionQueue
  logs:
    httpApi: true
  tracing:
    lambda: true
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
        - sqs:GetQueueUrl
      Resource:
        - !GetAtt TransactionQueue.Arn
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
        - logs:DescribeLogStreams
        - logs:FilterLogEvents
      Resource: '*'

plugins:
  - serverless-plugin-typescript
  - serverless-offline
  - serverless-plugin-warmup

functions:
  # Main API application
  app:
    handler: dist/lambda.handler
    events:
      - httpApi: '*'
    warmup:
      enabled: true
      prewarm: true

  # SQS Transaction Worker
  transactionWorker:
    handler: dist/workers/transactionWorker.handler
    timeout: 300
    memorySize: 1024
    events:
      - sqs:
          arn: !GetAtt TransactionQueue.Arn
          batchSize: 1
          maximumBatchingWindowInSeconds: 10
    environment:
      ADMIN_PRIVATE_KEY: ${env:ADMIN_PRIVATE_KEY}
      ADMIN_ADDRESS: ${env:ADMIN_ADDRESS}

  # Job Status Cleanup (runs daily)
  jobCleanup:
    handler: dist/workers/jobCleanup.handler
    timeout: 60
    events:
      - schedule: rate(1 day)

  # Swagger UI hosting
  swaggerUI:
    handler: dist/swagger.handler
    events:
      - httpApi:
          path: /docs
          method: get
      - httpApi:
          path: /docs/{proxy+}
          method: get

resources:
  Resources:
    # SQS Queue for Transaction Processing
    TransactionQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-transaction-queue-${self:provider.stage}
        VisibilityTimeoutSeconds: 360
        MessageRetentionPeriod: 1209600 # 14 days
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt TransactionDLQ.Arn
          maxReceiveCount: 3

    # Dead Letter Queue for failed transactions
    TransactionDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-transaction-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # 14 days

custom:
  serverless-offline:
    httpPort: 3000
    noAuth: true
    resourceRoutes: true

  serverless-plugin-typescript:
    tsConfigFileLocation: 'tsconfig.json'

  warmup:
    prewarm: true
    concurrency: 2

package:
  patterns:
    - '!src/**'
    - '!tests/**'
    - '!node_modules/@types/**'
    - '!*.md'
    - dist/**
    - build/swagger.json
