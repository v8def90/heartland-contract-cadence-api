service: heartland-api-v3
frameworkVersion: '4'

provider:
  name: aws
  runtime: nodejs22.x
  region: ${env:AWS_REGION, 'ap-northeast-1'}
  stage: ${opt:stage, 'dev'}
  profile: ${env:AWS_PROFILE, 'default'}
  timeout: 30
  memorySize: 512
  environment:
    NODE_ENV: ${opt:stage, 'dev'}
    FLOW_ACCESS_NODE: ${env:FLOW_ACCESS_NODE}
    HEART_CONTRACT_ADDRESS: ${env:HEART_CONTRACT_ADDRESS}
    JWT_SECRET: ${env:JWT_SECRET}
    # SQS resources
    TRANSACTION_QUEUE_URL:
      Ref: TransactionQueue
    # DynamoDB resources
    SNS_TABLE_NAME:
      Ref: SnsTable
    # S3 resources
    S3_BUCKET_NAME:
      Ref: AppAssetsBucket
    # CLOUDFRONT_DOMAIN: 後で追加
  # logs:
  #   httpApi: true
  tracing:
    lambda: true
  iamRoleStatements:
    - Effect: Allow
      Action:
        - sqs:SendMessage
        - sqs:ReceiveMessage
        - sqs:DeleteMessage
        - sqs:GetQueueAttributes
        - sqs:GetQueueUrl
      Resource:
        - !GetAtt TransactionQueue.Arn
        - !GetAtt ImageProcessingDLQ.Arn
    - Effect: Allow
      Action:
        - logs:CreateLogGroup
        - logs:CreateLogStream
        - logs:PutLogEvents
        - logs:DescribeLogStreams
        - logs:FilterLogEvents
      Resource: '*'
    - Effect: Allow
      Action:
        - dynamodb:PutItem
        - dynamodb:GetItem
        - dynamodb:Query
        - dynamodb:UpdateItem
        - dynamodb:DeleteItem
        - dynamodb:BatchWriteItem
        - dynamodb:BatchGetItem
        - dynamodb:Scan
      Resource:
        - !GetAtt SnsTable.Arn
        - !Sub '${SnsTable.Arn}/index/*'
    - Effect: Allow
      Action:
        - s3:GetObject
        - s3:PutObject
        - s3:DeleteObject
        - s3:ListBucket
        - s3:GetObjectVersion
        - s3:DeleteObjectVersion
      Resource:
        - !GetAtt AppAssetsBucket.Arn
        - !Sub '${AppAssetsBucket.Arn}/*'
    - Effect: Allow
      Action:
        - cloudfront:CreateInvalidation
      Resource: '*'

plugins:
  - serverless-offline

# Lambda Layers定義 (最適化版)
layers:
  # 基本ランタイム Layer (~5MB)
  runtimeLayer:
    path: layers/runtime
    name: ${self:service}-runtime-${self:provider.stage}
    description: Basic runtime dependencies - dotenv, jsonwebtoken, tsoa
    compatibleRuntimes:
      - nodejs22.x
    retain: false
    package:
      patterns:
        - nodejs/**
        - nodejs/node_modules/.pnpm/**
        - '!**/README.md'
        - '!**/test/**'
        - '!**/*.map'

  # 統合ブロックチェーン Layer (~160MB)
  blockchainLayer:
    path: layers/blockchain
    name: ${self:service}-blockchain-${self:provider.stage}
    description: Unified blockchain layer - Flow SDK, viem, WalletConnect
    compatibleRuntimes:
      - nodejs22.x
    retain: false
    package:
      patterns:
        - nodejs/**
        - '!**/README.md'
        - '!**/test/**'
        - '!**/*.map'

  # AWS SDK Layer (~19MB)
  awsSdkLayer:
    path: layers/aws-sdk
    name: ${self:service}-aws-sdk-${self:provider.stage}
    description: AWS SDK dependencies
    compatibleRuntimes:
      - nodejs22.x
    retain: false
    package:
      patterns:
        - nodejs/**
        - nodejs/node_modules/.pnpm/**
        - '!**/README.md'
        - '!**/test/**'
        - '!**/*.map'

  # Web依存関係 Layer (~15MB)
  webDepsLayer:
    path: layers/web-deps
    name: ${self:service}-web-deps-${self:provider.stage}
    description: Web dependencies - Express, Swagger
    compatibleRuntimes:
      - nodejs22.x
    retain: false
    package:
      patterns:
        - nodejs/**
        - '!**/README.md'
        - '!**/test/**'
        - '!**/*.map'

  # Sharp画像処理 Layer - 一時的に無効化（サイズ制限のため）
  # Sharp画像処理 Layer - サイズ制限のため無効化
  # sharpLayer:
  #   path: layers/sharp
  #   name: ${self:service}-sharp-${self:provider.stage}
  #   description: Sharp library for image processing
  #   compatibleRuntimes:
  #     - nodejs22.x
  #   retain: false
  #   package:
  #     patterns:
  #       - nodejs/**
  #       - '!**/README.md'
  #       - '!**/test/**'
  #       - '!**/*.map'

functions:
  # Main API application
  app:
    handler: dist/lambda.handler
    timeout: 25
    layers:
      - { Ref: RuntimeLayerLambdaLayer } # 基本ランタイム
      - { Ref: AwsSdkLayerLambdaLayer }
      - { Ref: BlockchainLayerLambdaLayer } # Flow SDK統合
      - { Ref: WebDepsLayerLambdaLayer }
    events:
      - httpApi: '*'

  # SQS Transaction Worker
  transactionWorker:
    handler: dist/workers/transactionWorker.handler
    timeout: 300
    memorySize: 1024
    layers:
      - { Ref: RuntimeLayerLambdaLayer } # 基本ランタイム
      - { Ref: AwsSdkLayerLambdaLayer }
      - { Ref: BlockchainLayerLambdaLayer } # WalletConnect含む統合Layer
    events:
      - sqs:
          arn: !GetAtt TransactionQueue.Arn
          batchSize: 1
    environment:
      ADMIN_PRIVATE_KEY: ${env:ADMIN_PRIVATE_KEY}
      ADMIN_ADDRESS: ${env:ADMIN_ADDRESS}

  # Job Status Cleanup (runs daily)
  jobCleanup:
    handler: dist/workers/jobCleanup.handler
    timeout: 60
    layers:
      - { Ref: RuntimeLayerLambdaLayer } # 基本ランタイム
      - { Ref: AwsSdkLayerLambdaLayer } # CloudWatch Logs用
    events:
      - schedule: rate(1 day)

  # Swagger UI hosting
  swaggerUI:
    handler: dist/swagger.handler
    timeout: 25
    layers:
      - { Ref: RuntimeLayerLambdaLayer } # 基本ランタイム
      - { Ref: WebDepsLayerLambdaLayer } # Swagger UI用
    events:
      - httpApi:
          path: /docs
          method: get
      - httpApi:
          path: /docs/{proxy+}
          method: get

  # 画像アップロード用プリサインURL発行
  uploadPresign:
    handler: dist/handlers/uploadPresign.handler
    timeout: 30
    memorySize: 512
    layers:
      - { Ref: RuntimeLayerLambdaLayer }
      - { Ref: AwsSdkLayerLambdaLayer }
    events:
      - httpApi:
          path: /sns/users/{userId}/upload/{imageType}
          method: post
    environment:
      S3_BUCKET_NAME:
        Ref: AppAssetsBucket

  # 画像処理Lambda
  imageProcessor:
    handler: dist/workers/imageProcessor.handler
    timeout: 60
    memorySize: 2048
    layers:
      - { Ref: RuntimeLayerLambdaLayer }
      - { Ref: AwsSdkLayerLambdaLayer }
      # - { Ref: SharpLayerLambdaLayer } # サイズ制限のため無効化
    events:
      - s3:
          bucket: !Ref AppAssetsBucket
          event: s3:ObjectCreated:*
          rules:
            - prefix: uploads/
            - suffix: .orig
          existing: true
    onError: !GetAtt ImageProcessingDLQ.Arn
    environment:
      S3_BUCKET_NAME:
        Ref: AppAssetsBucket
      SNS_TABLE_NAME:
        Ref: SnsTable

  # 画像削除Lambda
  imageCleanup:
    handler: dist/workers/imageCleanup.handler
    timeout: 30
    memorySize: 512
    layers:
      - { Ref: RuntimeLayerLambdaLayer }
      - { Ref: AwsSdkLayerLambdaLayer }
    events:
      - stream:
          type: dynamodb
          arn: !GetAtt SnsTable.StreamArn
          filterPatterns:
            - eventName: [REMOVE]
            - dynamodb:
                Keys:
                  SK:
                    S: [PROFILE]

  # ジョブ追跡API
  jobTracking:
    handler: dist/handlers/jobTracking.handler
    timeout: 30
    memorySize: 512
    layers:
      - { Ref: RuntimeLayerLambdaLayer }
      - { Ref: AwsSdkLayerLambdaLayer }
    events:
      - httpApi:
          path: /sns/jobs
          method: post
      - httpApi:
          path: /sns/jobs/{jobId}
          method: get
      - httpApi:
          path: /sns/jobs/{jobId}
          method: put
      - httpApi:
          path: /sns/jobs/user/{userId}
          method: get

resources:
  Resources:
    # SQS Queue for Transaction Processing
    TransactionQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-transaction-queue-${self:provider.stage}
        VisibilityTimeout: 360
        MessageRetentionPeriod: 1209600 # 14 days
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt TransactionDLQ.Arn
          maxReceiveCount: 3

    # Dead Letter Queue for failed transactions
    TransactionDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-transaction-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # 14 days

    # SNS DynamoDB Table
    SnsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:service}-sns-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: PK
            AttributeType: S
          - AttributeName: SK
            AttributeType: S
          - AttributeName: GSI1PK
            AttributeType: S
          - AttributeName: GSI1SK
            AttributeType: S
          - AttributeName: GSI2PK
            AttributeType: S
          - AttributeName: GSI2SK
            AttributeType: S
          - AttributeName: GSI3PK
            AttributeType: S
          - AttributeName: GSI3SK
            AttributeType: S
          - AttributeName: GSI4PK
            AttributeType: S
          - AttributeName: GSI4SK
            AttributeType: S
          - AttributeName: GSI5PK
            AttributeType: S
          - AttributeName: GSI5SK
            AttributeType: S
        KeySchema:
          - AttributeName: PK
            KeyType: HASH
          - AttributeName: SK
            KeyType: RANGE
        GlobalSecondaryIndexes:
          # GSI1: User posts (USER#{userId}#POSTS, createdAt)
          - IndexName: GSI1
            KeySchema:
              - AttributeName: GSI1PK
                KeyType: HASH
              - AttributeName: GSI1SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI2: Post comments (POST#{postId}#COMMENTS, createdAt)
          - IndexName: GSI2
            KeySchema:
              - AttributeName: GSI2PK
                KeyType: HASH
              - AttributeName: GSI2SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI3: User likes (USER#{userId}#LIKES, likedAt)
          - IndexName: GSI3
            KeySchema:
              - AttributeName: GSI3PK
                KeyType: HASH
              - AttributeName: GSI3SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI4: User following (USER#{userId}#FOLLOWING, targetUserId)
          - IndexName: GSI4
            KeySchema:
              - AttributeName: GSI4PK
                KeyType: HASH
              - AttributeName: GSI4SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
          # GSI5: User followers (USER#{userId}#FOLLOWERS, followerId)
          - IndexName: GSI5
            KeySchema:
              - AttributeName: GSI5PK
                KeyType: HASH
              - AttributeName: GSI5SK
                KeyType: RANGE
            Projection:
              ProjectionType: ALL
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES

    # S3 Bucket for App Assets (簡素化版)
    AppAssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:service}-app-assets-${self:provider.stage}-v5
        CorsConfiguration:
          CorsRules:
            - AllowedOrigins: ['*']
              AllowedMethods: [GET, PUT, POST, DELETE]
              AllowedHeaders: ['*']
              MaxAge: 3600
        PublicAccessBlockConfiguration:
          BlockPublicAcls: false
          BlockPublicPolicy: false
          IgnorePublicAcls: false
          RestrictPublicBuckets: false
      DeletionPolicy: Retain

    # CloudFront設定は後で追加（IAM権限が必要）

    # DLQ for image processing
    ImageProcessingDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: ${self:service}-image-processing-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600 # 14 days

    # CloudWatch Alarms for image processing monitoring - 一時的に無効化（権限不足）
    # ImageProcessingFailureAlarm:
    #   Type: AWS::CloudWatch::Alarm
    #   Properties:
    #     AlarmName: ${self:service}-image-processing-failures-${self:provider.stage}
    #     AlarmDescription: Alert when image processing failures occur
    #     MetricName: Errors
    #     Namespace: AWS/Lambda
    #     Statistic: Sum
    #     Period: 300
    #     EvaluationPeriods: 1
    #     Threshold: 5
    #     ComparisonOperator: GreaterThanThreshold
    #     Dimensions:
    #       - Name: FunctionName
    #         Value: !Ref ImageProcessorLambdaFunction
    #     TreatMissingData: notBreaching

    # ImageProcessingDurationAlarm:
    #   Type: AWS::CloudWatch::Alarm
    #   Properties:
    #     AlarmName: ${self:service}-image-processing-duration-${self:provider.stage}
    #     AlarmDescription: Alert when image processing takes too long
    #     MetricName: Duration
    #     Namespace: AWS/Lambda
    #     Statistic: Average
    #     Period: 300
    #     EvaluationPeriods: 2
    #     Threshold: 45000  # 45 seconds
    #     ComparisonOperator: GreaterThanThreshold
    #     Dimensions:
    #       - Name: FunctionName
    #         Value: !Ref ImageProcessorLambdaFunction
    #     TreatMissingData: notBreaching

    # DLQMessageAlarm:
    #   Type: AWS::CloudWatch::Alarm
    #   Properties:
    #     AlarmName: ${self:service}-dlq-messages-${self:provider.stage}
    #     AlarmDescription: Alert when messages are sent to DLQ
    #     MetricName: ApproximateNumberOfVisibleMessages
    #     Namespace: AWS/SQS
    #     Statistic: Average
    #     Period: 300
    #     EvaluationPeriods: 1
    #     Threshold: 1
    #     ComparisonOperator: GreaterThanOrEqualToThreshold
    #     Dimensions:
    #       - Name: QueueName
    #         Value: !GetAtt ImageProcessingDLQ.QueueName
    #     TreatMissingData: notBreaching

custom:
  serverless-offline:
    httpPort: 3000
    noAuth: true
    resourceRoutes: true

package:
  # 完全除外: node_modulesを含めない（Layersで提供）
  excludeDevDependencies: false # この機能は無効化

  patterns:
    # 必要最小限のファイルのみ含める
    - 'dist/**'
    - 'build/swagger.json'
    - 'package.json'
    - 'transactions/**' # Cadence transactionファイルを含める
    - 'scripts/**' # Cadence scriptファイルを含める

    # 全依存関係を明示的に除外（Layersで提供）
    - '!node_modules/**'

    # 開発・設定ファイルを除外
    - '!src/**'
    - '!tests/**'
    - '!coverage/**'
    - '!layers/**'
    - '!aws-policies/**'
    - '!contracts/**'
    - '!docs/**'
    - '!*.md'
    - '!.env*'
    - '!.cursor*'
    - '!.git*'
    - '!.eslint*'
    - '!.prettier*'
    - '!.serverless*'
    - '!tsconfig.json'
    - '!tsoa.json'
    - '!jest.config.js'
    - '!eslint.config.js'
    - '!flow.json'
    - '!setup-minter-role.js'
    - '!test-keys.js'
    - '!.env.sample'
    - '!package-*.json'
    - '!pnpm-lock.yaml'
