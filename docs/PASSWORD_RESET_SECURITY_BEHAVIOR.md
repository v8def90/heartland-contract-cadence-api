# パスワードリセット要求のセキュリティ動作

**作成日**: 2026-01-03  
**対象**: `POST /auth/reset-password-request`エンドポイント

---

## ❓ 質問

**パスワードリセット要求で、登録されていないメールアドレスからリセット要求が来た場合の動作はどうなりますか？**

## ✅ 回答

**登録されていないメールアドレスの場合でも、常に成功レスポンス（`200 OK`）を返します。**

これは**セキュリティ上のベストプラクティス**です。メールアドレスの存在を明かさないことで、ユーザー列挙攻撃を防ぎます。

---

## 🔍 実装詳細

### 処理フロー

```
1. リクエスト受信
   ↓
2. メールアドレス正規化
   ↓
3. ユーザー検索（DynamoDBIdentityLookupItem）
   ↓
4. ユーザーが見つからない場合
   ↓
5. ✅ success: true を返す（メールは送信しない）
```

### コード実装

```typescript:568:577:src/services/UserAuthService.ts
// Get user by email (via identity lookup)
const lookup = await this.snsService.getIdentityLookup(
  `email:${normalizedEmail}`
);
if (!lookup || lookup.status !== 'verified') {
  // Don't reveal if email exists for security
  return {
    success: true, // Return success even if email doesn't exist
  };
}
```

**重要なポイント**:
- ユーザーが見つからない場合、`success: true`を返します
- 実際にはメールは送信されません
- エラーレスポンスは返しません

---

## 📋 動作パターン

### パターン1: 登録されていないメールアドレス

**リクエスト**:
```json
{
  "email": "nonexistent@example.com"
}
```

**処理**:
1. ユーザー検索 → 見つからない
2. `success: true`を返す
3. メールは送信されない

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "sent": true
  },
  "timestamp": "2026-01-03T00:00:00.000Z"
}
```

**HTTPステータスコード**: `200 OK`

### パターン2: 登録されているがメール未認証

**リクエスト**:
```json
{
  "email": "unverified@example.com"
}
```

**処理**:
1. ユーザー検索 → 見つかる
2. メール認証状態を確認 → 未認証
3. `success: true`を返す
4. メールは送信されない

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "sent": true
  },
  "timestamp": "2026-01-03T00:00:00.000Z"
}
```

**HTTPステータスコード**: `200 OK`

### パターン3: 登録済み・メール認証済み

**リクエスト**:
```json
{
  "email": "verified@example.com"
}
```

**処理**:
1. ユーザー検索 → 見つかる
2. メール認証状態を確認 → 認証済み
3. リセットトークンを生成
4. トークンをデータベースに保存
5. パスワードリセットメールを送信
6. `success: true`を返す

**レスポンス**:
```json
{
  "success": true,
  "data": {
    "sent": true
  },
  "timestamp": "2026-01-03T00:00:00.000Z"
}
```

**HTTPステータスコード**: `200 OK`

---

## 🔐 セキュリティ上の考慮事項

### 1. ユーザー列挙攻撃の防止

**問題**: メールアドレスの存在を明かすと、攻撃者が有効なメールアドレスを列挙できる

**解決策**: 登録されていないメールアドレスでも成功レスポンスを返す

**メリット**:
- ✅ メールアドレスの存在を明かさない
- ✅ ユーザー列挙攻撃を防止
- ✅ セキュリティベストプラクティスに準拠

### 2. レスポンスの一貫性

**すべてのケースで同じレスポンス**:
- 登録されていないメールアドレス → `200 OK` + `success: true`
- メール未認証 → `200 OK` + `success: true`
- メール認証済み → `200 OK` + `success: true`

**メリット**:
- ✅ 攻撃者がメールアドレスの存在を推測できない
- ✅ レスポンス時間の違いからも情報を漏洩しない

### 3. メール送信の最適化

**実装**:
- メール認証済みのユーザーのみにメールを送信
- 未登録・未認証の場合はメール送信をスキップ

**メリット**:
- ✅ 不要なメール送信を削減
- ✅ AWS SESのコスト削減
- ✅ スパムメールの防止

---

## 📊 処理フロー図

```
┌─────────────────────┐
│ POST /auth/reset-   │
│ password-request    │
│ {email: "xxx"}      │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ メールアドレス正規化 │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ ユーザー検索         │
│ (IdentityLookup)     │
└──────────┬──────────┘
           │
           ├─ 見つからない
           │  └─→ ✅ success: true（メール送信なし）
           │
           └─ 見つかった
              │
              ▼
      ┌─────────────────────┐
      │ メール認証状態確認    │
      └──────────┬───────────┘
                 │
                 ├─ 未認証
                 │  └─→ ✅ success: true（メール送信なし）
                 │
                 └─ 認証済み
                    │
                    ▼
            ┌─────────────────────┐
            │ リセットトークン生成 │
            │ トークン保存         │
            │ メール送信           │
            └──────────┬───────────┘
                       │
                       └─→ ✅ success: true（メール送信あり）
```

---

## 🧪 テストシナリオ

### シナリオ1: 登録されていないメールアドレス

```bash
curl -X POST "https://dev-api.heart-land.io/auth/reset-password-request" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "nonexistent@example.com"
  }'
```

**期待されるレスポンス**:
```json
{
  "success": true,
  "data": {
    "sent": true
  },
  "timestamp": "2026-01-03T00:00:00.000Z"
}
```

**実際の動作**:
- ✅ HTTPステータスコード: `200 OK`
- ✅ レスポンス: `success: true`
- ❌ メールは送信されない
- ❌ エラーログは出力されない

### シナリオ2: 登録済み・メール認証済み

```bash
curl -X POST "https://dev-api.heart-land.io/auth/reset-password-request" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "verified@example.com"
  }'
```

**期待されるレスポンス**:
```json
{
  "success": true,
  "data": {
    "sent": true
  },
  "timestamp": "2026-01-03T00:00:00.000Z"
}
```

**実際の動作**:
- ✅ HTTPステータスコード: `200 OK`
- ✅ レスポンス: `success: true`
- ✅ メールが送信される
- ✅ リセットトークンがデータベースに保存される

---

## ⚠️ 重要な注意事項

### 1. レスポンスの一貫性

**すべてのケースで同じレスポンスを返す**:
- 登録されていないメールアドレス
- メール未認証のユーザー
- メール認証済みのユーザー

**理由**: メールアドレスの存在を明かさないため

### 2. メール送信の条件

**メールが送信される条件**:
1. ユーザーが存在する
2. メール認証が完了している（`emailVerified: true`）

**メールが送信されない条件**:
1. ユーザーが存在しない
2. メール認証が完了していない

### 3. セキュリティ上の利点

**この実装により**:
- ✅ ユーザー列挙攻撃を防止
- ✅ メールアドレスの存在を明かさない
- ✅ レスポンス時間の違いからも情報を漏洩しない
- ✅ セキュリティベストプラクティスに準拠

---

## 📚 参考資料

### OWASP推奨事項

OWASP（Open Web Application Security Project）では、パスワードリセット機能において、メールアドレスの存在を明かさないことを推奨しています。

**推奨事項**:
- 登録されていないメールアドレスでも成功レスポンスを返す
- エラーメッセージでメールアドレスの存在を明かさない
- レスポンス時間の違いからも情報を漏洩しない

### 実装の準拠

この実装は以下のセキュリティガイドラインに準拠しています：
- ✅ OWASP Authentication Cheat Sheet
- ✅ NIST Digital Identity Guidelines
- ✅ ISO/IEC 27001 セキュリティ管理

---

## 🔄 代替実装との比較

### 代替案1: エラーレスポンスを返す（非推奨）

```json
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "Email address not found"
  }
}
```

**問題点**:
- ❌ メールアドレスの存在を明かす
- ❌ ユーザー列挙攻撃を可能にする
- ❌ セキュリティリスクが高い

### 代替案2: 遅延レスポンス（非推奨）

登録されていないメールアドレスの場合、メール送信処理と同じ時間だけ待機してからレスポンスを返す。

**問題点**:
- ❌ レスポンス時間が長くなる
- ❌ ユーザー体験が悪化
- ❌ 実装が複雑になる

### 現在の実装（推奨）

**すべてのケースで成功レスポンスを返す**

**メリット**:
- ✅ セキュリティが高い
- ✅ 実装がシンプル
- ✅ ユーザー体験が良い
- ✅ 業界標準のベストプラクティス

---

## 📝 まとめ

### 登録されていないメールアドレスの場合

1. **レスポンス**: `200 OK` + `success: true`
2. **メール送信**: なし
3. **エラーログ**: なし
4. **セキュリティ**: メールアドレスの存在を明かさない

### 実装の特徴

- ✅ セキュリティベストプラクティスに準拠
- ✅ ユーザー列挙攻撃を防止
- ✅ レスポンスの一貫性を保持
- ✅ 不要なメール送信を削減

---

**最終更新**: 2026-01-03  
**実装状況**: ✅ 実装完了

